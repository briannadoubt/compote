name: Release

on:
  push:
    tags:
      - 'v*'
      - '[0-9]+.[0-9]+.[0-9]+*'

permissions:
  contents: write
  pull-requests: write

jobs:
  create-release:
    name: Create Release
    runs-on: macos-26
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Release
        run: |
          swift build -c release

      - name: Run Tests
        run: |
          swift test

      - name: Configure macOS signing keychain
        env:
          MACOS_CERTIFICATE_P12: ${{ secrets.MACOS_CERTIFICATE_P12 }}
          MACOS_CERTIFICATE_PASSWORD: ${{ secrets.MACOS_CERTIFICATE_PASSWORD }}
          MACOS_KEYCHAIN_PASSWORD: ${{ secrets.MACOS_KEYCHAIN_PASSWORD }}
        run: |
          set -euo pipefail

          if [[ -z "${MACOS_CERTIFICATE_P12}" || -z "${MACOS_CERTIFICATE_PASSWORD}" || -z "${MACOS_KEYCHAIN_PASSWORD}" ]]; then
            echo "Missing required signing secrets. Configure MACOS_CERTIFICATE_P12, MACOS_CERTIFICATE_PASSWORD, and MACOS_KEYCHAIN_PASSWORD." >&2
            exit 1
          fi

          CERT_PATH="$RUNNER_TEMP/compote-signing-cert.p12"
          KEYCHAIN_PATH="$RUNNER_TEMP/compote-signing.keychain-db"

          echo -n "${MACOS_CERTIFICATE_P12}" | base64 --decode > "$CERT_PATH"

          security create-keychain -p "${MACOS_KEYCHAIN_PASSWORD}" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "${MACOS_KEYCHAIN_PASSWORD}" "$KEYCHAIN_PATH"
          security import "$CERT_PATH" -P "${MACOS_CERTIFICATE_PASSWORD}" -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          security list-keychains -d user -s "$KEYCHAIN_PATH"
          security default-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "${MACOS_KEYCHAIN_PASSWORD}" "$KEYCHAIN_PATH"

      - name: Sign release binary
        env:
          MACOS_SIGNING_IDENTITY: ${{ secrets.MACOS_SIGNING_IDENTITY }}
        run: |
          set -euo pipefail

          if [[ -z "${MACOS_SIGNING_IDENTITY}" ]]; then
            echo "Missing required signing secret: MACOS_SIGNING_IDENTITY." >&2
            exit 1
          fi

          codesign \
            --force \
            --timestamp \
            --options runtime \
            --sign "${MACOS_SIGNING_IDENTITY}" \
            --entitlements .github/entitlements/compote.entitlements \
            .build/release/compote

          codesign --verify --strict --verbose=2 .build/release/compote
          codesign -d --entitlements :- .build/release/compote

      - name: Create Release Archive
        run: |
          mkdir -p release
          cp .build/release/compote release/
          tar -czf compote-${{ github.ref_name }}-macos-arm64.tar.gz -C release compote
          shasum -a 256 compote-${{ github.ref_name }}-macos-arm64.tar.gz > compote-${{ github.ref_name }}-macos-arm64.tar.gz.sha256

      - name: Create GitHub Release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          TAG="${{ github.ref_name }}"
          ARCHIVE="compote-${TAG}-macos-arm64.tar.gz"
          CHECKSUM="${ARCHIVE}.sha256"

          RELEASE_NOTES=$(cat <<EOF
          ## Installation

          ### Homebrew (Recommended)
          \`\`\`bash
          brew tap briannadoubt/tap
          brew install compote
          \`\`\`

          ### Manual Installation
          \`\`\`bash
          # Download and extract
          tar -xzf ${ARCHIVE}
          sudo mv compote /usr/local/bin/

          # Install dependencies
          brew install container
          container system start
          \`\`\`

          ### Verify Installation
          \`\`\`bash
          compote setup
          \`\`\`

          ## What's Changed
          See the full changelog below.
          EOF
          )

          PRERELEASE_FLAG=""
          if [[ "${TAG}" == *alpha* || "${TAG}" == *beta* || "${TAG}" == *rc* ]]; then
            PRERELEASE_FLAG="--prerelease"
          fi

          if gh release view "${TAG}" >/dev/null 2>&1; then
            gh release edit "${TAG}" ${PRERELEASE_FLAG} --draft=false --notes "${RELEASE_NOTES}"
          else
            gh release create "${TAG}" \
              ${PRERELEASE_FLAG} \
              --draft=false \
              --generate-notes \
              --notes "${RELEASE_NOTES}" \
              "${ARCHIVE}" \
              "${CHECKSUM}"
          fi

          gh release upload "${TAG}" "${ARCHIVE}" "${CHECKSUM}" --clobber

      - name: Cleanup signing keychain
        if: always()
        run: |
          KEYCHAIN_PATH="$RUNNER_TEMP/compote-signing.keychain-db"
          security delete-keychain "$KEYCHAIN_PATH" || true

  build-bottle:
    name: Build Homebrew Bottle
    runs-on: macos-26
    needs: create-release
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build bottle from formula
        id: bottle
        run: |
          set -euo pipefail
          TAG="${{ github.ref_name }}"
          VERSION="${TAG#v}"
          REPO="${{ github.repository }}"
          TAP_NAME="local/compote-bottle"

          curl -L -o source.tar.gz "https://github.com/${REPO}/archive/refs/tags/${TAG}.tar.gz"
          SOURCE_SHA=$(shasum -a 256 source.tar.gz | awk '{print $1}')

          mkdir -p /tmp/compote-bottle
          cp Formula/compote.rb /tmp/compote-bottle/compote.rb
          sed -i '' "s|url \".*\"|url \"https://github.com/${REPO}/archive/refs/tags/${TAG}.tar.gz\"|" /tmp/compote-bottle/compote.rb
          sed -i '' "s|sha256 \".*\"|sha256 \"${SOURCE_SHA}\"|" /tmp/compote-bottle/compote.rb

          brew tap-new "${TAP_NAME}" >/dev/null
          TAP_REPO="$(brew --repo "${TAP_NAME}")"
          cp /tmp/compote-bottle/compote.rb "${TAP_REPO}/Formula/compote.rb"

          brew install --build-bottle "${TAP_NAME}/compote"
          brew bottle --json "${TAP_NAME}/compote"

          BOTTLE_FILE=$(ls -1 compote--*.bottle.tar.gz | head -n1)
          BOTTLE_JSON=$(ls -1 compote--*.bottle.json | head -n1)

          echo "bottle_file=${BOTTLE_FILE}" >> "$GITHUB_OUTPUT"
          echo "bottle_json=${BOTTLE_JSON}" >> "$GITHUB_OUTPUT"

      - name: Upload bottle assets to release
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          set -euo pipefail
          gh release upload \
            "${{ github.ref_name }}" \
            "${{ steps.bottle.outputs.bottle_file }}" \
            "${{ steps.bottle.outputs.bottle_json }}" \
            --clobber

  update-formula:
    name: Update Homebrew Formula
    runs-on: macos-26
    needs: [create-release, build-bottle]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get release info
        id: release_info
        run: |
          # Download the release archive
          curl -L -o compote.tar.gz \
            https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.ref_name }}.tar.gz

          # Calculate SHA256
          SHA256=$(shasum -a 256 compote.tar.gz | awk '{print $1}')
          echo "sha256=$SHA256" >> $GITHUB_OUTPUT

          # Extract version
          VERSION="${{ github.ref_name }}"
          VERSION="${VERSION#v}"
          echo "version=$VERSION" >> $GITHUB_OUTPUT

          # Download bottle for current macOS runner target
          BOTTLE_TAG="arm64_tahoe"
          BOTTLE_FILE="compote--${VERSION}.${BOTTLE_TAG}.bottle.tar.gz"
          curl -L -o "${BOTTLE_FILE}" \
            "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}/${BOTTLE_FILE}"
          BOTTLE_SHA256=$(shasum -a 256 "${BOTTLE_FILE}" | awk '{print $1}')
          echo "bottle_file=${BOTTLE_FILE}" >> $GITHUB_OUTPUT
          echo "bottle_tag=${BOTTLE_TAG}" >> $GITHUB_OUTPUT
          echo "bottle_sha256=${BOTTLE_SHA256}" >> $GITHUB_OUTPUT

      - name: Update Formula
        run: |
          ruby <<'RUBY'
          path = "Formula/compote.rb"
          content = File.read(path)

          content = content.sub(
            /url ".*"/,
            "url \"https://github.com/${{ github.repository }}/archive/refs/tags/${{ github.ref_name }}.tar.gz\""
          )
          content = content.sub(
            /sha256 ".*"/,
            "sha256 \"${{ steps.release_info.outputs.sha256 }}\""
          )

          # Replace any existing bottle block.
          content = content.gsub(/(?m)^  bottle do\n.*?^  end\n\n/, "")

          bottle_block = <<~BOTTLE
            bottle do
              root_url "https://github.com/${{ github.repository }}/releases/download/${{ github.ref_name }}"
              sha256 ${{ steps.release_info.outputs.bottle_tag }}: "${{ steps.release_info.outputs.bottle_sha256 }}"
            end

          BOTTLE

          indented_bottle_block = bottle_block.lines.map { |line| "  #{line}" }.join
          content = content.sub(/(  head ".*"\n\n)/, "\\1#{indented_bottle_block}")
          File.write(path, content)
          RUBY

      - name: Create Pull Request
        env:
          GH_TOKEN: ${{ secrets.GH_PR_TOKEN || github.token }}
        run: |
          set -euo pipefail
          BRANCH="formula-update-${{ github.ref_name }}"
          BRANCH="${BRANCH//\//-}"
          TITLE="Update formula to ${{ github.ref_name }}"
          BODY=$(cat <<EOF
          Automated formula update for release ${{ github.ref_name }} with bottle metadata.

          - Version: ${{ steps.release_info.outputs.version }}
          - Source SHA256: ${{ steps.release_info.outputs.sha256 }}
          - Bottle: ${{ steps.release_info.outputs.bottle_file }}
          - Bottle SHA256: ${{ steps.release_info.outputs.bottle_sha256 }}
          EOF
          )

          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git checkout -B "$BRANCH"
          git add Formula/compote.rb

          if git diff --cached --quiet; then
            echo "No formula changes to commit; skipping PR creation."
            exit 0
          fi

          git commit -m "$TITLE"
          git push --force-with-lease origin "$BRANCH"

          EXISTING_PR=$(gh pr list --head "$BRANCH" --base main --state open --json number --jq '.[0].number // empty')
          if [ -n "$EXISTING_PR" ]; then
            gh pr edit "$EXISTING_PR" --title "$TITLE" --body "$BODY" --base main
          else
            gh pr create --base main --head "$BRANCH" --title "$TITLE" --body "$BODY"
          fi
